name: Build HymoFS

env:
  CPU: common
  FEIL: gki
  ANDROID_VERSION: android16
  KERNEL_VERSION: 6.12
  proxy: On
  APPLY_HYMOFS: On
  APPLY_ADIOS: On
  KERNEL_MANIFEST: common-android16-6.12-2025-09

on:
  push
         
jobs:
  build:
    name: Build Kernel Only - HymoFS Test
    runs-on: ubuntu-latest
    env:
      CCACHE_COMPILERCHECK: "%compiler% -dumpmachine; %compiler% -dumpversion"
      CCACHE_NOHASHDIR: "true"
      CCACHE_HARDLINK: "true"
      CCACHE_MAXSIZE: 8G
      
    steps:
      - name: "ğŸš€ Maximize Build Space | æœ€å¤§åŒ–æ„å»ºç©ºé—´"
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 8192
          temp-reserve-mb: 4096
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            patch/
          sparse-checkout-cone-mode: false

      # ====================== ç³»ç»Ÿåˆå§‹åŒ–é˜¶æ®µ ======================
      - name: "ğŸ” Configure Git | é…ç½®Gitè´¦æˆ·"
        run: |
          echo "ğŸ”§ æ­£åœ¨é…ç½®Gitç”¨æˆ·ä¿¡æ¯..."
          git config --global user.name "smarturtlee"
          git config --global user.email "2024312277@stu.hit.edu.cn"
          echo "âœ… Gité…ç½®å®Œæˆ"

      # ====================== ä¾èµ–ç®¡ç†é˜¶æ®µ ======================
      - name: "ğŸ“¦ Cache & Install Dependencies | ç¼“å­˜ & å®‰è£…æ„å»ºä¾èµ–"
        uses: awalsh128/cache-apt-pkgs-action@latest 
        with: 
          packages: python3 git curl libelf-dev build-essential flex bison libssl-dev libncurses-dev liblz4-tool zlib1g-dev libxml2-utils rsync unzip gawk dos2unix
          execute_install_scripts: true

      # ====================== æºç å‡†å¤‡é˜¶æ®µ ======================
      - name: "ğŸ“¥ Install Repo Tool | å®‰è£…Repoå·¥å…·"
        run: |
          echo "â¬‡ï¸ æ­£åœ¨ä¸‹è½½repoå·¥å…·..."
          curl -fsSL https://storage.googleapis.com/git-repo-downloads/repo > ~/repo
          chmod a+x ~/repo
          sudo mv ~/repo /usr/local/bin/repo
          echo "âœ… repoå·¥å…·å®‰è£…å®Œæˆ"

      - name: "â¬‡ï¸ Clone Kernel Source | å…‹éš†å†…æ ¸æºç "
        run: |
          git clone https://github.com/WildKernels/AnyKernel3 --depth=1
          rm -rf ./AnyKernel3/.git
          mkdir kernel_workspace && cd kernel_workspace
          mkdir kernel_platform
          cd kernel_platform
          
          echo "ğŸŒ æ­£åœ¨åˆå§‹åŒ–å†…æ ¸ä»“åº“..."
          repo init -u https://android.googlesource.com/kernel/manifest -b ${{ env.KERNEL_MANIFEST }} --depth=1

          echo "ğŸ”„ åŒæ­¥ä»£ç åº“(ä½¿ç”¨$(nproc --all)çº¿ç¨‹)..."
          repo sync -c -j$(nproc --all) --no-tags --no-clone-bundle --force-sync
          cd ../
          echo "âœ… å†…æ ¸æºç å…‹éš†å®Œæˆ" 
     
          sed -i '/protected_module_names_list = ":gki_aarch64_protected_module_names",/d' kernel_platform/common/BUILD.bazel

          echo "ğŸ”§ æ­£åœ¨é…ç½®å†…æ ¸ç‰ˆæœ¬ä¿¡æ¯..."
          # Remove -dirty in kernel version
          sed -i 's/ -dirty//g' kernel_platform/common/scripts/setlocalversion || true
          sed -i 's/ -dirty//g' kernel_platform/msm-kernel/scripts/setlocalversion || true
          sed -i 's/ -dirty//g' kernel_platform/external/dtc/scripts/setlocalversion || true
          sed -i '$i res=$(echo "$res" | sed '\''s/-dirty//g'\'')' kernel_platform/common/scripts/setlocalversion || true
          sed -i '$i res=$(echo "$res" | sed '\''s/-dirty//g'\'')' kernel_platform/msm-kernel/scripts/setlocalversion || true
          sed -i '$i res=$(echo "$res" | sed '\''s/-dirty//g'\'')' kernel_platform/external/dtc/scripts/setlocalversion || true

          echo "âœ… å†…æ ¸é…ç½®å®Œæˆ"
      
      - name: "âš™ï¸ Apply HymoFS Patch | åº”ç”¨ HymoFS è¡¥ä¸"
        if: ${{ env.APPLY_HYMOFS == 'On' }}
        run: |
          cd kernel_workspace/kernel_platform/common
          patch -p1 -F 3 < ${{ github.workspace }}/patch/hymofs.patch
          echo "  [*] HymoFS ä»£ç æ³¨å…¥å®Œæˆï¼"
          
      - name: "âš™ï¸ Configure Kernel Options | é…ç½®å†…æ ¸é€‰é¡¹"
        run: |
          cd kernel_workspace/kernel_platform

          echo "âš™ï¸ æ­£åœ¨é…ç½®å†…æ ¸ç¼–è¯‘é€‰é¡¹..."

          if [ "${{ env.APPLY_HYMOFS }}" = "On" ]; then
            echo "CONFIG_HYMOFS=y" >> ./common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_HYMOFS_REVERSE_LOOKUP=y" >> ./common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_HYMOFS_FORWARD_REDIRECT=y" >> ./common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_HYMOFS_HIDE_ENTRIES=y" >> ./common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_HYMOFS_INJECT_ENTRIES=y" >> ./common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_HYMOFS_STAT_SPOOF=y" >> ./common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_HYMOFS_XATTR_FILTER=y" >> ./common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_HYMOFS_UNAME_SPOOF=y" >> ./common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_HYMOFS_CMDLINE_SPOOF=y" >> ./common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_HYMOFS_DEBUG=y" >> ./common/arch/arm64/configs/gki_defconfig
          fi

          echo "ğŸ“¦ æ·»åŠ å¯¹ Mountify (backslashxx/mountify) æ¨¡å—çš„æ”¯æŒ"
          echo "CONFIG_TMPFS_XATTR=y" >> ./common/arch/arm64/configs/gki_defconfig
          echo "CONFIG_TMPFS_POSIX_ACL=y" >> ./common/arch/arm64/configs/gki_defconfig


          if [ "${{ env.proxy }}" == "On" ]; then
            # Add proxy config
            echo "ğŸ“¦ åŠ å…¥ä»£ç†ä¼˜åŒ–..."
            echo "CONFIG_BPF_STREAM_PARSER=y" >> ./common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_NETFILTER_XT_MATCH_ADDRTYPE=y" >> ./common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_NETFILTER_XT_SET=y" >> ./common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_IP_SET=y" >> ./common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_IP_SET_MAX=65534" >> ./common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_IP_SET_BITMAP_IP=y" >> ./common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_IP_SET_BITMAP_IPMAC=y" >> ./common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_IP_SET_BITMAP_PORT=y" >> ./common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_IP_SET_HASH_IP=y" >> ./common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_IP_SET_HASH_IPMARK=y" >> ./common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_IP_SET_HASH_IPPORT=y" >> ./common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_IP_SET_HASH_IPPORTIP=y" >> ./common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_IP_SET_HASH_IPPORTNET=y" >> ./common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_IP_SET_HASH_IPMAC=y" >> ./common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_IP_SET_HASH_MAC=y" >> ./common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_IP_SET_HASH_NETPORTNET=y" >> ./common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_IP_SET_HASH_NET=y" >> ./common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_IP_SET_HASH_NETNET=y" >> ./common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_IP_SET_HASH_NETPORT=y" >> ./common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_IP_SET_HASH_NETIFACE=y" >> ./common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_IP_SET_LIST_SET=y" >> ./common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_IP6_NF_NAT=y" >> ./common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_IP6_NF_TARGET_MASQUERADE=y" >> ./common/arch/arm64/configs/gki_defconfig
          fi
          if [ "${{ env.APPLY_ADIOS }}" == "On" ]; then
            # Add proxy config
            echo "ğŸ“¦ ADIOS..."
            echo "CONFIG_MQ_IOSCHED_ADIOS=y" >> ./common/arch/arm64/configs/gki_defconfig
            echo "CONFIG_MQ_IOSCHED_DEFAULT_ADIOS=y" >> ./common/arch/arm64/configs/gki_defconfig
          fi
          # Remove check_defconfig
          sed -i 's/check_defconfig//' ./common/build.config.gki
          # Replace error echo with a return in kleaf_internal_check_defconfig_minimized
          
          sed -i 's|echo ERROR: savedefconfig does not match "${source_config}" >&2|return 0|' ./build/kernel/_setup_env.sh || true
          
          echo "âœ… å†…æ ¸é…ç½®æ›´æ–°å®Œæˆ"
          
      - name: "ğŸ”¨ Build Kernel | ç¼–è¯‘å†…æ ¸"
        run: |
          echo "ğŸ—ï¸ å¼€å§‹å†…æ ¸ç¼–è¯‘..."
          
          cd kernel_workspace/kernel_platform

          tools/bazel run //common:kernel_aarch64_dist
          
          echo "âœ… å†…æ ¸ç¼–è¯‘å®Œæˆ"

      - name: "ğŸ§  Set Artifact Name | è®¾ç½®äº§ç‰©åç§°"
        id: set_name
        run: |
          echo "ARTIFACT_NAME=${{ env.FEIL }}_SukiSU_Ultra_${{ env.KSUVER }}" >> $GITHUB_OUTPUT
      
      - name: "ğŸ“¦ Package Kernel | æ‰“åŒ…å†…æ ¸"
        run: |
          echo "ğŸ“¦ å‡†å¤‡AnyKernel3æ‰“åŒ…ç¯å¢ƒ..."
          mkdir -p kernel_workspace/kernel_platform/out/Final-Image-Find/
          dir1=""
          dir2=""
          image_path=$(find "kernel_workspace/kernel_platform/out/kernel_aarch64/dist" -name "Image" | head -n 1)
          if [ -n "$image_path" ]; then
            dir1=$(dirname "$image_path")/
            echo "âœ… æˆåŠŸæ‰¾åˆ° Image æ–‡ä»¶"
          fi
          if [ -n "$image_path" ] && [ -f "$image_path" ]; then
            echo "Image file finally located at: $image_path"
            cp "$image_path" ./AnyKernel3/Image
            cp "$image_path" kernel_workspace/kernel_platform/out/Final-Image-Find/Image
          fi
          cd AnyKernel3
          zip -r ../${{ steps.set_name.outputs.ARTIFACT_NAME }}.zip ./*
          cd ..
          cp ${{ steps.set_name.outputs.ARTIFACT_NAME }}.zip kernel_workspace/
          echo "âœ… å†…æ ¸æ‰“åŒ…å®Œæˆ: ${{ steps.set_name.outputs.ARTIFACT_NAME }}.zip"


      # ====================== ä¸Šä¼ é˜¶æ®µ ======================

      - name: "ğŸ“¤ Upload AnyKernel3 | ä¸Šä¼  AnyKernel3"
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.set_name.outputs.ARTIFACT_NAME }}.zip
          path: ./kernel_workspace/${{ steps.set_name.outputs.ARTIFACT_NAME }}.zip
